# @one710/recollect

[![Publish](https://github.com/one710/recollect/actions/workflows/publish.yml/badge.svg)](https://github.com/one710/recollect/actions/workflows/publish.yml)
[![npm version](https://img.shields.io/npm/v/@one710/recollect.svg)](https://www.npmjs.com/package/@one710/recollect)
[![npm downloads](https://img.shields.io/npm/dm/@one710/recollect.svg)](https://www.npmjs.com/package/@one710/recollect)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://github.com/one710/recollect/blob/main/LICENSE)
[![TypeScript](https://img.shields.io/badge/TypeScript-Ready-3178C6?logo=typescript&logoColor=white)](https://www.typescriptlang.org/)

Recollect is a provider-agnostic memory + compaction layer for long-running AI chats.

It keeps full session history, automatically compacts older context when needed, and preserves recent turns and instruction context so your app stays coherent as conversations grow.

## Why Recollect

- Uses provider-agnostic `RecollectMessage` structs
- Session-based memory with pluggable storage
- Robust compaction strategy with summary checkpoints
- Predictable, explicit API

## Installation

```bash
npm install @one710/recollect
```

If you want SQLite persistence:

```bash
npm install sqlite3
```

If you only use `InMemoryStorageAdapter`, `sqlite3` is not required.

## Quick Start (Manual Memory API)

```typescript
import { MemoryLayer, type SummaryRequest } from "@one710/recollect";

const summarize = async (input: SummaryRequest): Promise<string> => {
  // Call your preferred LLM/provider here.
  // input.instructions: summarization instructions
  // input.summaryPrompt: rendered transcript text to summarize
  // input.messages: raw structured messages
  return "Summary generated by my custom LLM implementation.";
};

const memory = new MemoryLayer({
  maxTokens: 8192,
  summarize,
});

const sessionId = "chat:user-123";

await memory.addMessage(sessionId, "user", "What should we build next?");
await memory.addMessage(
  sessionId,
  "assistant",
  "Let's prioritize onboarding improvements.",
);

await memory.addMessage(sessionId, null, {
  role: "assistant",
  content: [
    {
      type: "tool-call",
      toolCallId: "call-1",
      toolName: "lookupMetric",
      input: { key: "paid_subs_us_pct" } as any,
    },
  ],
});

await memory.addMessage(sessionId, null, {
  role: "tool",
  content: [
    {
      type: "tool-result",
      toolCallId: "call-1",
      toolName: "lookupMetric",
      output: { type: "json", value: { key: "paid_subs_us_pct", value: 63.2 } },
    },
  ],
});

const history = await memory.getMessages(sessionId);
console.log(history.length);
```

## Message Model

Recollect stores and returns `RecollectMessage[]`:

- `role`: `system | developer | user | assistant | tool`
- `content`: `string` or typed parts (text/file/tool-call/tool-result/reasoning/unknown)

This keeps the core library independent from any single provider SDK.

## Custom Summarizer Callback

`MemoryLayer` requires a `summarize` callback:

- input:
  - `instructions`: summarization instructions text
  - `summaryPrompt`: rendered transcript text representation
  - `messages`: raw structured `RecollectMessage[]`
- output:
  - summary `string`

## API Overview

### `MemoryLayer` options

- `maxTokens` (required)
- `summarize` (required)
- `threshold` (default `0.9`)
- `targetTokensAfterCompaction` (default `65%` of `maxTokens`)
- `keepRecentUserTurns` (default `4`)
- `keepRecentMessagesMin` (default `8`)
- `maxCompactionPasses` (default `3`)
- `minimumMessagesToCompact` (default `6`)
- `countTokens` (optional custom tokenizer)
- `storage` (optional custom adapter)
- `databasePath` (used only when `storage` is not provided)
- `onCompactionEvent` (optional diagnostics hook)

### `MemoryLayer` methods

- `addMessage(sessionId, role, contentOrMessage)`
- `addMessages(sessionId, messages)`
- `getMessages(sessionId)`
- `getPromptMessages(sessionId)`
- `compactNow(sessionId)`
- `compactIfNeeded(sessionId, options)`
- `getSessionEvents(sessionId, limit?)`
- `getSessionSnapshot(sessionId)`
- `clearSession(sessionId)`
- `dispose()`

## Storage

Exports:

- `InMemoryStorageAdapter`
- `createSQLiteStorageAdapter(databasePath)`
- `MemoryStorageAdapter` type (for custom adapters)

## Development

```bash
npm install
npm run build
npm test
```

## License

MIT
